<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Outfit Generator</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#A6E6FD;min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;font-family:Arial,Helvetica,sans-serif}
    .container{display:flex;flex-direction:column;align-items:center;min-height:100vh}
    .title{margin-bottom:30px;cursor:pointer;user-select:none}
    .title-row{display:flex;justify-content:center;margin-bottom:6px}
    .letter-block{background:#FF0;border:2px solid #000;width:42px;height:42px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold;margin:0 2px}
    .canvas-container{background:#fff;width:360px;height:450px;margin-bottom:30px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 10px rgba(0,0,0,.1);position:relative}
    .clothing-spot{position:absolute;transition:transform .2s ease}
    .clothing-spot.clickable{cursor:pointer}
    .clothing-spot.clickable:hover{transform:scale(1.05)}
    .clothing-spot img{width:100%;height:100%;object-fit:contain}
    .generate-btn{background:#fff;border:2px solid #000;padding:15px 30px;font-size:18px;font-weight:bold;cursor:pointer;border-radius:8px;margin-bottom:10px}
    .save-btn{background:#007AFF;color:#fff;border:0;padding:12px 25px;border-radius:20px;cursor:pointer;margin:5px}
    .admin-btn{position:fixed;top:10px;right:10px;background:#ff4444;color:#fff;border:0;padding:8px 16px;border-radius:5px;font-size:12px;z-index:100;opacity:0;visibility:hidden;transition:opacity .3s ease}
    .admin-btn.show{opacity:1;visibility:visible}
    .admin-panel{display:none;background:#f0f0f0;padding:20px;margin:20px auto;max-width:350px;border-radius:10px;border:2px solid #000}
    .admin-panel.show{display:block}
    .admin-panel input,.admin-panel select,.admin-panel button{width:100%;padding:10px;margin:5px 0;border:1px solid #ccc;border-radius:5px;font-size:14px}
    .admin-panel button{background:#333;color:#fff;cursor:pointer}
    .upload-status{margin:10px 0;padding:10px;border-radius:5px;font-size:14px;display:none}
    .upload-status.success{background:#d4edda;color:#155724}
    .upload-status.error{background:#f8d7da;color:#721c24}
  </style>
</head>
<body>
  <button class="admin-btn" id="adminBtn" onclick="toggleAdmin()">Admin</button>
  <div class="container">
    <div class="title" onclick="secretClick()">
      <div class="title-row">
        <div class="letter-block">O</div><div class="letter-block">U</div><div class="letter-block">T</div>
        <div class="letter-block">F</div><div class="letter-block">I</div><div class="letter-block">T</div>
      </div>
      <div class="title-row">
        <div class="letter-block">G</div><div class="letter-block">E</div><div class="letter-block">N</div>
        <div class="letter-block">E</div><div class="letter-block">R</div><div class="letter-block">A</div>
        <div class="letter-block">T</div><div class="letter-block">O</div><div class="letter-block">R</div>
      </div>
    </div>

    <div class="admin-panel" id="adminPanel">
      <h3>Add Item</h3>
      <input type="file" id="fileInput" accept="image/*">
      <select id="categoryInput">
        <option value="">Select Category</option>
        <option value="tops">Tops</option>
        <option value="bottoms">Bottoms</option>
        <option value="dresses">Dresses</option>
        <option value="outerwear">Outerwear</option>
        <option value="shoes">Shoes</option>
        <option value="boots">Boots</option>
        <option value="bags">Bags</option>
        <option value="accessories">Accessories</option>
      </select>
      <input type="url" id="linkInput" placeholder="Shopping link (optional)">
      <div id="uploadStatus" class="upload-status"></div>
      <button onclick="addItem()">Upload & Save</button>
    </div>

    <div class="canvas-container" id="outfitCanvas"></div>
    <button class="generate-btn" onclick="generateOutfit()">Generate</button>
    <button class="save-btn" onclick="saveOutfit()">Save Outfit</button>
  </div>

  <script>
    /* ---------- YOU'RE DONE CONFIGURING: these are already filled ---------- */
    const CLOUD_NAME   = "dpykewcjw";
    const UPLOAD_PRESET= "Outfitgenerator";
    const ADD_ITEM_URL = "https://evojxuzstvjpqxrfiwqf.supabase.co/functions/v1/add-item";
    const GENERATE_URL = "https://evojxuzstvjpqxrfiwqf.supabase.co/functions/v1/generate";
    const ADMIN_TOKEN  = ""; // leave blank unless you set one in Supabase
    /* ---------------------------------------------------------------------- */

    // Secret admin toggle (tap title 5x)
    let clicks=0,last=0;
    function secretClick(){const now=Date.now();if(now-last>2000)clicks=0;clicks++;last=now;
      if(clicks>=5){document.getElementById("adminBtn").classList.add("show");clicks=0;}}
    function toggleAdmin(){document.getElementById("adminPanel").classList.toggle("show");}

    function showStatus(msg,type="success"){const el=document.getElementById("uploadStatus");el.textContent=msg;el.className="upload-status "+type;el.style.display="block";setTimeout(()=>{el.style.display="none"},4000);}

    async function uploadToCloudinary(file){
      const form=new FormData();
      form.append("file",file);
      form.append("upload_preset",UPLOAD_PRESET);
      const res=await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:"POST",body:form});
      const json=await res.json();
      if(!json.secure_url) throw new Error(json.error?.message || "Cloudinary upload failed");
      return json.secure_url;
    }

    async function addItem(){
      const file=document.getElementById("fileInput").files[0];
      const type=document.getElementById("categoryInput").value;
      const shop_link=document.getElementById("linkInput").value.trim();
      if(!file||!type){showStatus("Pick a file + category","error");return;}
      try{
        showStatus("Uploading…");
        const image_url=await uploadToCloudinary(file);

        showStatus("Saving…");
        const headers={"content-type":"application/json"};
        if(ADMIN_TOKEN) headers["authorization"] = `Bearer ${ADMIN_TOKEN}`;
        const res=await fetch(ADD_ITEM_URL,{method:"POST",headers,body:JSON.stringify({type,image_url,shop_link:shop_link||null})});
        const out=await res.json();
        if(!res.ok) throw new Error(out?.error || "Save failed");
        showStatus("Saved ✓");
        document.getElementById("fileInput").value="";
        document.getElementById("categoryInput").value="";
        document.getElementById("linkInput").value="";
      }catch(e){showStatus(e.message,"error");}
    }

    async function fetchOutfit(){
      const res=await fetch(GENERATE_URL,{cache:"no-store"});
      const json=await res.json();
      if(!res.ok) throw new Error(json?.error || "Generate failed");
      return json.items||[];
    }

    function placeItem(c,it){
      const pos={tops:{top:"15px",left:"50%",transform:"translateX(-50%)",width:"160px",height:"130px",zIndex:"3"},
        dresses:{top:"15px",left:"50%",transform:"translateX(-50%)",width:"160px",height:"200px",zIndex:"3"},
        bottoms:{top:"120px",left:"50%",transform:"translateX(-50%)",width:"140px",height:"170px",zIndex:"2"},
        bags:{top:"100px",left:"20px",width:"110px",height:"110px",zIndex:"5"},
        accessories:{top:"80px",right:"20px",width:"50px",height:"50px",zIndex:"4"},
        shoes:{bottom:"25px",left:"50%",transform:"translateX(-50%)",width:"100px",height:"70px",zIndex:"1"},
        boots:{bottom:"25px",left:"50%",transform:"translateX(-50%)",width:"140px",height:"100px",zIndex:"1"},
        outerwear:{top:"5px",right:"10px",width:"120px",height:"150px",zIndex:"4"}};
      const d=document.createElement("div");d.className="clothing-spot";Object.assign(d.style,pos[it.type]||{});
      if(it.shop_link){d.classList.add("clickable");d.onclick=()=>window.open(it.shop_link,"_blank");}
      d.innerHTML=`<img src="${it.image_url}" alt="${it.type}">`;c.appendChild(d);
    }

    async function generateOutfit(){
      const c=document.getElementById("outfitCanvas");c.innerHTML="";
      try{
        const items=await fetchOutfit();
        const hasDress=items.some(i=>i.type==="dresses");
        const order=["dresses","tops","bottoms","bags","accessories","outerwear","shoes","boots"];
        for(const t of order){
          if((t==="tops"||t==="bottoms")&&hasDress) continue;
          const it=items.find(x=>x.type===t); if(it) placeItem(c,it);
        }
        const hasShoes=items.some(i=>i.type==="shoes");
        const hasBoots=items.some(i=>i.type==="boots");
        if(hasShoes&&hasBoots){
          const hide=Math.random()<0.5?"shoes":"boots";
          const el=c.querySelector(`img[alt="${hide}"]`);
          if(el&&el.parentNode) el.parentNode.remove();
        }
      }catch(e){alert("Could not generate outfit: "+e.message);}
    }

    function saveOutfit(){alert("Take a screenshot to save your outfit!");}
  </script>
</body>
</html>
